---
title: "scratchwork2"
format: html
---

## PART 2

```{r}
##THIS chunk doesn't work
library(wehoop)
library(dplyr)
library(purrr)

teams <- c(
  1611661329, # Las Vegas Aces
  1611661317, # Chicago Sky
  1611661328, # Connecticut Sun
  1611661319, # Dallas Wings
  1611661322, # Indiana Fever
  1611661324, # Los Angeles Sparks
  1611661323, # Minnesota Lynx
  1611661320, # New York Liberty
  1611661325, # Phoenix Mercury
  1611661321  # Seattle Storm
)


all_players <- map_dfr(teams, ~ wnba_franchiseplayers(team = .x)) #%>%
#  select(PERSON_ID, PLAYER) %>%
#  distinct()
```

```{r}
library(tidyr)
library(dplyr)

all_players_clean <- all_players %>%
  unnest(FranchisePlayers) %>%
  select(PERSON_ID, PLAYER) %>%
  distinct()
```

```{r}
players <- all_players_clean %>%
  rename(PLAYER_ID = PERSON_ID) %>%
  arrange(PLAYER)
```

```{r}
library(purrr)
library(wehoop)
library(dplyr)

safe_gamelog <- possibly(
  ~ wnba_playergamelogs(
      player_id = .x,
      season = "2024"   # or most_recent_wnba_season()
    ),
  otherwise = NULL
)

```

```{r}
library(progress)

pb <- progress_bar$new(
  format = "Pulling gamelogs [:bar] :current/:total (:percent)",
  total = nrow(players),
  clear = FALSE,
  width = 60
)

player_games <- map_dfr(players$PLAYER_ID, function(pid) {
  pb$tick()
  Sys.sleep(0.6)  # VERY important: prevents rate-limiting
  safe_gamelog(pid)
})

```

```{r}
player_games_clean <- player_games %>%
  unnest(PlayerGameLogs) %>%
  mutate(
    GAME_DATE = as.Date(GAME_DATE),
    PLAYER_ID = as.integer(PLAYER_ID)
  )
```

```{r}
saveRDS(player_games_clean, "data/player_games_2024.rds")

```

```{r}
attendance_2024 <- full_data %>%
  filter(Season == 2024)
```

# computing win shares (by game)

## offensive contribution:

```{r}
player_games_clean <- player_games_clean %>%
  mutate(
    FGA = as.numeric(FGA),
    FTA = as.numeric(FTA),
    TOV = as.numeric(TOV),
    PTS = as.numeric(PTS),
    AST = as.numeric(AST)
  )

player_games_clean <- player_games_clean %>%
  mutate(
    off_poss = FGA + 0.44 * FTA + TOV
  )

player_games_clean <- player_games_clean %>%
  mutate(
    points_produced = PTS + 0.5 * AST
  )

league_ppp <- player_games_clean %>%
  group_by(SEASON_YEAR) %>%
  summarise(
    league_ppp = sum(PTS) / sum(off_poss),
    .groups = "drop"
  )

player_games_clean <- player_games_clean %>%
  left_join(league_ppp, by = "SEASON_YEAR") %>%
  mutate(
    marginal_offense = points_produced - league_ppp * off_poss
  )
```

## defensive contribution:

```{r}
player_games_clean <- player_games_clean %>%
  mutate(
    STL = as.numeric(STL),
    BLK = as.numeric(BLK),
    DREB = as.numeric(DREB),
    MIN = as.numeric(MIN)
  )

player_games_clean <- player_games_clean %>%
  mutate(
    defensive_index = STL + BLK + 0.5 * DREB
  )
```

```{r}
player_season_2024 <- player_games_clean %>%
  filter(SEASON_YEAR == "2024") %>%
  group_by(PLAYER_ID, PLAYER_NAME, TEAM_ID, TEAM_NAME) %>%
  summarise(
    marginal_offense = sum(marginal_offense, na.rm = TRUE),
    defensive_index  = sum(defensive_index, na.rm = TRUE),
    minutes          = sum(MIN, na.rm = TRUE),
    .groups = "drop"
  )

```

```{r}
player_ws_2024 <- player_season_2024 %>%
  group_by(TEAM_ID) %>%
  mutate(
    team_offense = sum(marginal_offense[marginal_offense > 0], na.rm = TRUE),
    team_defense = sum(defensive_index, na.rm = TRUE),

    off_win_share =
      if_else(marginal_offense > 0,
              marginal_offense / team_offense,
              0),

    def_win_share = defensive_index / team_defense,

    win_share = off_win_share + def_win_share
  ) %>%
  ungroup()

```

# i need to figure out how to generate team win counts across the season, I could honestly just look them all up...

```{r}
team_wins_2024 <- tibble::tribble(
  ~team_name,              ~team_wins,
  "New York Liberty",      32,
  "Minnesota Lynx",        30,
  "Connecticut Sun",       28,
  "Las Vegas Aces",        27,
  "Seattle Storm",         25,
  "Indiana Fever",         20,
  "Phoenix Mercury",       19,
  "Atlanta Dream",         15,
  "Washington Mystics",    14,
  "Chicago Sky",           13,
  "Dallas Wings",          9,
  "Los Angeles Sparks",    8
)

team_wins_2024 <- team_wins_2024|>
  mutate(
    team_name = toupper(team_name)
  )
```

```{r}
player_ws_2024 <- player_ws_2024 %>%
  left_join(team_wins_2024, by = c("team_name")) %>%
  mutate(
    player_win_shares = win_share * team_wins.y
  )
```

```{r}
display_plot <- player_ws_2024|>
  select(
    PLAYER_NAME,
    TEAM_NAME,
    marginal_offense,
    defensive_index,
    minutes,
    off_win_share,
    def_win_share,
    win_share,
    player_win_shares,
    team_wins
  )|>
  mutate(attendance = player_win_shares*112)|>
  arrange(desc(player_win_shares))|>
  head(n=15)


```

```{r}
library(gt)
library(dplyr)

# Format numeric columns nicely
display_table <- display_plot %>%
  mutate(
    marginal_offense = round(marginal_offense, 1),
    defensive_index  = round(defensive_index, 1),
    minutes          = round(minutes, 0),
    off_win_share    = round(off_win_share, 2),
    def_win_share    = round(def_win_share, 2),
    win_share        = round(win_share, 2),
    player_win_shares = round(player_win_shares, 2)
  ) %>%
  gt() %>%
  tab_header(
    title = "Top 15 Player Win Shares (2024)"
  ) %>%
  cols_label(
    PLAYER_NAME = "Player",
    TEAM_NAME = "Team",
    marginal_offense = "Marginal Offense",
    defensive_index = "Defensive Index",
    minutes = "Minutes",
    off_win_share = "Off WS",
    def_win_share = "Def WS",
    win_share = "Total WS",
    player_win_shares = "Scaled WS",
    team_wins = "Team Wins",
    attendance = "Est. Attendance"
  ) %>%
  fmt_number(
    columns = c(off_win_share, def_win_share, win_share, player_win_shares),
    decimals = 2
  ) %>%
  fmt_number(
    columns = c(marginal_offense, defensive_index),
    decimals = 1
  ) %>%
  fmt_number(
    columns = minutes,
    decimals = 0
  ) %>%
  tab_options(
    table.font.size = px(12),
    table.width = pct(100)
  )

# Print the table in R
display_table

# Optionally, save as PNG for your manuscript
library(webshot2)
gtsave(display_table, "images/top10_player_win_shares.png")

```

```{r}
library(ggplot2)

ws_dist_plot <- ggplot(player_ws_2024, aes(x = player_win_shares)) +
  geom_histogram(
    bins = 30,
    color = "white",
    alpha = 0.85
  ) +
  labs(
    title = "Distribution of Player Win Shares in the WNBA (2024)",
    x = "Player Win Shares",
    y = "Number of Players"
  ) +
  theme_minimal(base_size = 11) +
  geom_vline(
    xintercept = mean(player_ws_2024$win_share, na.rm = TRUE),
    linetype = "dashed",
    linewidth = 0.8
  )

ggsave(
  "images/win_share_distribution_2024.png",
  ws_dist_plot,
  width = 5,
  height = 3.5,
  dpi = 300
)

```

```{r}
library(gt)
library(dplyr)

attendance_2025 <- read.csv("attendance_data/att_25.csv")

attendance_table <- attendance_2025 %>%
  select(
    Date,
    Team,
    Opponent,
    Arena,
    City,
    State,
    Attendance
  ) %>%
  filter(Team == "Atlanta Dream")|>
  head(10) %>%   # show first 10 rows (adjust as needed)
  gt() %>%
  tab_header(
    title = "WNBA Game Attendance (2025 Season)",
    subtitle = "Sample of game-level attendance records"
  ) %>%
  cols_label(
    Date = "Game Date",
    Team = "Home Team",
    Opponent = "Opponent",
    Arena = "Arena",
    City = "City",
    State = "State",
    Attendance = "Attendance"
  ) %>%
  fmt_number(
    columns = Attendance,
    decimals = 0
  ) %>%
  tab_options(
    table.font.size = px(11),
    table.width = pct(100)
  )

attendance_table

```

```{r}
library(webshot2)

gtsave(
  attendance_table,
  "images/attendance_2025_table.png"
)

```
